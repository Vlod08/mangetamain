name: Python Linter && Auto Fix (Ruff & Black)
on:
  push:
    branches-ignore:
      - 'main'
      - 'auto/ruff-fixes**'
  workflow_dispatch:    # allow manual triggering
jobs:
  autofix:
    name: Run ruff --fix, format with black and create PR
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: python -m pip install --upgrade pip && pip install "poetry==2.2.0"

      - name: Install test dependencies
        run: |
          poetry install --no-interaction --with test

      - name: Run ruff --fix
        run: |
          poetry run ruff check src/mangetamain --fix || true

      - name: Run black
        run: |
          poetry run black src/mangetamain || true

      - name: Check for remaining lint issues
        id: lint-check
        run: |
          # Run ruff check (without --fix) to see if any issues remain
          if poetry run ruff check src/mangetamain; then
            echo "lint_issues=false" >> $GITHUB_OUTPUT
            echo "No linting issues remaining"
          else
            echo "lint_issues=true" >> $GITHUB_OUTPUT
            echo "Linting issues still present after auto-fixes"
          fi
    
      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Determine if PR needed
        id: pr-needed
        run: |
          # Create/update PR if: 1) There are changes OR 2) There are unfixable lint issues
          if [ "${{ steps.check-changes.outputs.has_changes }}" = "true" ] || [ "${{ steps.lint-check.outputs.lint_issues }}" = "true" ]; then
            echo "create_pr=true" >> $GITHUB_OUTPUT
          else
            echo "create_pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Create or update pull request with fixes
        if: steps.pr-needed.outputs.create_pr == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ${{ steps.check-changes.outputs.has_changes == 'true' && 'chore: apply automatic ruff/black fixes' || 'chore: lint issues detected' }}
          branch: auto/ruff-fixes-${{ github.ref_name }}
          title: |
            Auto: Code Quality Fixes for ${{ github.ref_name }}
            ${{ steps.lint-check.outputs.lint_issues == 'true' && '(Needs Manual Fixes)' || '' }}
          body: |
            ${{ steps.check-changes.outputs.has_changes == 'true' && 'This pull request contains automatic fixes applied by ruff (lint) and Black (format).' || '**Lint issues detected that require manual fixes.**' }}

            ${{ steps.lint-check.outputs.lint_issues == 'true' && '‚ö†Ô∏è **MANUAL FIXES NEEDED**: Some linting issues require manual intervention.' || '‚úÖ All linting issues were automatically resolved.' }}

            ${{ steps.check-changes.outputs.has_changes == 'false' && steps.lint-check.outputs.lint_issues == 'true' && 'No automatic fixes were available for the detected issues. Please fix manually:' || '' }}

            ```bash
            poetry run ruff check src/mangetamain
            ```

            ---
            *Auto-generated by GitHub Actions*
          base: ${{ github.ref_name }}
          labels: |
            auto-fix
            ${{ steps.lint-check.outputs.lint_issues == 'true' && 'needs-work' || 'ready' }}
            ${{ steps.check-changes.outputs.has_changes == 'false' && 'lint-issues-only' || '' }}
          delete-branch: false


      - name: Fail pipeline when PR created
        if: steps.pr-needed.outputs.create_pr == 'true'
        run: |
          echo "‚ùå PIPELINE FAILED: Code quality issues detected"
          echo ""
          echo "üìã Created/updated pull request: auto/ruff-fixes-${{ github.ref_name }}"
          echo ""
          
          if [ "${{ steps.lint-check.outputs.lint_issues }}" = "true" ]; then
            echo "üö® MANUAL FIXES REQUIRED:"
            echo "Some linting issues require manual intervention."
            echo ""
            echo "Remaining issues:"
            poetry run ruff check src/mangetamain --output-format=concise
          else
            echo "‚úÖ ALL ISSUES AUTO-FIXED:"
            echo "All linting issues were automatically resolved."
          fi
          
          if [ "${{ steps.check-changes.outputs.has_changes }}" = "true" ]; then
            echo ""
            echo "üîß Automatic fixes were applied and committed."
          else
            echo ""
            echo "‚ÑπÔ∏è  No automatic fixes were available or needed."
          fi
          
          echo ""
          echo "üìù Please review and merge the pull request before continuing."
          echo "   PR: auto/ruff-fixes-${{ github.ref_name }} ‚Üí ${{ github.ref_name }}"
          
          exit 1